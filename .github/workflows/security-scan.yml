name: Security Scan

on:
  schedule:
    # Run every day at 03:00 UTC
    - cron: '0 3 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: mc-server-container:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'mc-server-container:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'mc-server-container:scan'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Run Trivy vulnerability scanner (JSON output)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'mc-server-container:scan'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH'

      - name: Check for vulnerabilities and create issue
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read Trivy results
            let trivyResults;
            try {
              const data = fs.readFileSync('trivy-results.json', 'utf8');
              trivyResults = JSON.parse(data);
            } catch (error) {
              console.log('No vulnerabilities file found or error reading it');
              return;
            }

            // Count vulnerabilities by severity
            let criticalCount = 0;
            let highCount = 0;

            if (trivyResults.Results) {
              trivyResults.Results.forEach(result => {
                if (result.Vulnerabilities) {
                  result.Vulnerabilities.forEach(vuln => {
                    if (vuln.Severity === 'CRITICAL') criticalCount++;
                    if (vuln.Severity === 'HIGH') highCount++;
                  });
                }
              });
            }

            if (criticalCount === 0 && highCount === 0) {
              console.log('‚úÖ No critical or high vulnerabilities found!');
              return;
            }

            // Check if security issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,automated',
              state: 'open'
            });

            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Security vulnerabilities detected')
            );

            const body = `## üîí Security Vulnerabilities Detected

            Trivy security scan found vulnerabilities in the container image:

            - **Critical:** ${criticalCount}
            - **High:** ${highCount}

            ### Action Required

            1. Review the vulnerabilities in the [Security tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
            2. Update affected dependencies or base image
            3. Rebuild and test the container
            4. Create a PR with fixes and add \`release:patch\` label

            ### Scan Details

            - **Scan Date:** ${new Date().toISOString()}
            - **Image:** mc-server-container:scan

            For detailed vulnerability information, check the workflow run:
            ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            ---
            *This issue was automatically created by the security-scan workflow.*`;

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`üìù Updated existing security issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üîí Security vulnerabilities detected in container',
                body: body,
                labels: ['security', 'automated', 'bug']
              });
              console.log(`üìù Created new security issue #${newIssue.data.number}`);
            }

  dockerfile-scan:
    name: Dockerfile Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy config scanner on Dockerfile
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config.sarif'

      - name: Upload Trivy config results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-config.sarif'
          category: 'dockerfile'

      - name: Run Trivy config scanner (table output)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
