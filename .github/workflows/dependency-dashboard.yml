name: Dependency Dashboard

on:
  schedule:
    # Run every Monday at 10:00 UTC
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  create-dashboard:
    name: Create Dependency Dashboard
    runs-on: ubuntu-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Collect repository information
        id: repo_info
        run: |
          # Count different file types
          SHELL_COUNT=$(find . -name "*.sh" -o -name "*.bash" | wc -l)
          PYTHON_COUNT=$(find . -name "*.py" | wc -l)
          YAML_COUNT=$(find . -name "*.yml" -o -name "*.yaml" | wc -l)
          DOCKERFILE_COUNT=$(find . -name "Dockerfile*" | wc -l)
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | wc -l)

          {
            echo "shell=$SHELL_COUNT"
            echo "python=$PYTHON_COUNT"
            echo "yaml=$YAML_COUNT"
            echo "dockerfile=$DOCKERFILE_COUNT"
            echo "workflows=$WORKFLOW_COUNT"
          } >> "$GITHUB_OUTPUT"

      - name: Check GitHub Actions versions
        id: actions_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -d .github/workflows ]]; then
            {
              echo "| Action | Current | Latest | Status |"
              echo "|--------|---------|--------|--------|"
            } > /tmp/actions_status.md

            # Extract all uses: statements and handle subpaths (owner/repo/path@version)
            grep -h "uses:" .github/workflows/*.yml 2>/dev/null | \
              sed 's/.*uses:[[:space:]]*//' | \
              sed 's/[[:space:]]*#.*//' | \
              grep '@' | \
              sort -u | \
              while IFS='@' read -r action current_ver; do
                # Skip local actions
                if [[ "$action" == ./* ]]; then
                  continue
                fi

                # Check rate limit periodically within loop
                rate_limit=$(gh api rate_limit --jq '.resources.core.remaining' 2>/dev/null || echo "0")
                if [[ "$rate_limit" -lt 10 ]]; then
                  printf "| \`%s\` | N/A | N/A | âš ï¸ Rate limit low |\n" "$action" >> /tmp/actions_status.md
                  echo "Remaining actions skipped due to rate limit exhaustion." >> /tmp/actions_status.md
                  break
                fi

                # Get owner/repo (only first two path components for API query)
                repo=$(echo "$action" | cut -d'/' -f1-2)

                # Query latest release with fallback to tags
                latest=$(gh api "repos/$repo/releases/latest" --jq '.tag_name' 2>/dev/null || \
                         gh api "repos/$repo/tags" --jq '.[0].name' 2>/dev/null || \
                         echo "N/A")

                # Handle empty response
                [ -z "$latest" ] && latest="N/A"

                # Normalize versions for comparison
                current_norm="${current_ver#v}"
                latest_norm="${latest#v}"
                current_major=$(echo "$current_norm" | cut -d'.' -f1)
                latest_major=$(echo "$latest_norm" | cut -d'.' -f1)

                # Determine status with improved version comparison
                if [[ "$latest" = "N/A" ]]; then
                  status="âš ï¸ API Error"
                elif [[ "$current_ver" = "$latest" ]]; then
                  status="âœ… Up-to-date"
                elif [[ "$current_major" = "$latest_norm" ]] || \
                     [[ "$current_norm" = "$latest_major" ]]; then
                  # Major-only version matches latest major (e.g., v4 = v4.1.0)
                  status="âœ… Up-to-date"
                else
                  status="â¬†ï¸ Update available"
                fi

                # Use printf for safer output formatting
                printf "| \`%s\` | %s | %s | %s |\n" \
                  "$action" "$current_ver" "$latest" "$status" >> /tmp/actions_status.md
              done

            cat /tmp/actions_status.md
          fi

      - name: Check for Dockerfile dependencies
        id: docker_check
        if: steps.repo_info.outputs.dockerfile > 0
        run: |
          {
            echo "# Docker Dependencies"
            echo ""
          } > /tmp/docker_status.md

          if [[ -f Dockerfile ]]; then
            FROM_LINE=$(grep '^FROM' Dockerfile | head -1)

            {
              echo "## Base Image"
              echo "- $FROM_LINE"
              echo ""
              echo "## ARG Versions"
            } >> /tmp/docker_status.md

            grep '^ARG.*VERSION' Dockerfile | while read -r line; do
              echo "- \`$line\`" >> /tmp/docker_status.md
            done || echo "- No ARG versions found" >> /tmp/docker_status.md
          fi

          cat /tmp/docker_status.md

      - name: Create or update dashboard issue
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Read collected information
            const repoInfo = {
              shell: ${{ steps.repo_info.outputs.shell }},
              python: ${{ steps.repo_info.outputs.python }},
              yaml: ${{ steps.repo_info.outputs.yaml }},
              dockerfile: ${{ steps.repo_info.outputs.dockerfile }},
              workflows: ${{ steps.repo_info.outputs.workflows }}
            };

            // Build dashboard body
            let body = `# ğŸ“Š Dependency Dashboard\n\n`;
            body += `**Last Updated:** ${new Date().toISOString()}\n\n`;
            body += `## Repository Statistics\n\n`;
            body += `| File Type | Count |\n`;
            body += `|-----------|-------|\n`;
            body += `| Shell Scripts | ${repoInfo.shell} |\n`;
            body += `| Python Files | ${repoInfo.python} |\n`;
            body += `| YAML Files | ${repoInfo.yaml} |\n`;
            body += `| Dockerfiles | ${repoInfo.dockerfile} |\n`;
            body += `| GitHub Workflows | ${repoInfo.workflows} |\n\n`;

            // Add actions status
            try {
              const actionsStatus = fs.readFileSync('/tmp/actions_status.md', 'utf8');
              body += `## GitHub Actions Dependencies\n\n${actionsStatus}\n\n`;
              body += `> ğŸ’¡ **Tip:** Update actions by running Dependabot or manually updating workflow files.\n\n`;
            } catch (e) {
              body += `## GitHub Actions Dependencies\n\nNo workflows found.\n\n`;
            }

            // Add docker status if exists
            try {
              const dockerStatus = fs.readFileSync('/tmp/docker_status.md', 'utf8');
              body += `${dockerStatus}\n\n`;
            } catch (e) {
              // Docker info not available
            }

            body += `## Dependency Management\n\n`;
            body += `- **Dependabot:** Automated weekly updates for GitHub Actions`;
            if (repoInfo.dockerfile > 0) {
              body += ` and Docker images`;
            }
            body += `\n`;
            body += `- **Security Scanning:** Trivy scans run daily at 03:00 UTC\n`;
            body += `- **Pre-commit Hooks:** Local validation before commits\n\n`;

            body += `## Quick Actions\n\n`;
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            body += `- [View Dependabot PRs](${repoUrl}/pulls?q=is%3Apr+is%3Aopen+label%3Adependencies)\n`;
            body += `- [View Security Issues](${repoUrl}/issues?q=is%3Aissue+is%3Aopen+label%3Asecurity)\n`;
            body += `- [Run Security Scan](${repoUrl}/actions/workflows/security-scan.yml)\n\n`;

            body += `---\n`;
            body += `*This dashboard is automatically updated every Monday at 10:00 UTC.*\n`;
            const workflowUrl = `${repoUrl}/actions/workflows/dependency-dashboard.yml`;
            body += `*To manually trigger an update, run the [Dependency Dashboard workflow](${workflowUrl}).*`;

            // Check if dashboard issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'dependencies,dashboard',
              state: 'open'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Dependency Dashboard')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`ğŸ“ Updated dashboard issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“Š Dependency Dashboard',
                body: body,
                labels: ['dependencies', 'dashboard', 'automated']
              });

              // Pin the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: newIssue.data.number,
                state: 'open'
              });

              console.log(`ğŸ“ Created dashboard issue #${newIssue.data.number}`);
            }
