name: Pre-commit Hook Updates

on:
  schedule:
    # Run every Monday at 09:30 UTC
    - cron: '30 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  check-updates:
    name: Check Pre-commit Hook Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: |
          pip install pre-commit
          pre-commit --version

      - name: Check for hook updates
        id: check
        run: |
          echo "Checking for pre-commit hook updates..."
          
          # Run autoupdate to check for updates (dry-run)
          pre-commit autoupdate > update-output.txt 2>&1 || true
          
          # Check if there are updates
          if grep -q "updating" update-output.txt; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "⚠️ Pre-commit hook updates available"
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "✅ All pre-commit hooks are up to date"
          fi
          
          # Save the output for later use
          cat update-output.txt
          echo "---" >> update-output.txt

      - name: Create PR with updates
        if: steps.check.outputs.updates_available == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Check if a PR already exists
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: 'chore/update-pre-commit-hooks'
            });

            if (prs.data.length > 0) {
              console.log(`PR already exists: #${prs.data[0].number}`);
              return;
            }

            // Create a new branch
            const branchName = 'chore/update-pre-commit-hooks';

            try {
              // Get the default branch ref
              const { data: ref } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/main'
              });

              // Create new branch
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: ref.object.sha
              });

              console.log(`✅ Created branch: ${branchName}`);

              // Run autoupdate to modify the file
              execSync('pre-commit autoupdate', { stdio: 'inherit' });

              // Read the updated file
              const updatedConfig = fs.readFileSync('.pre-commit-config.yaml', 'utf8');

              // Get current file content
              const { data: currentFile } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.pre-commit-config.yaml',
                ref: branchName
              });

              // Update file on the new branch
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.pre-commit-config.yaml',
                message: 'chore: update pre-commit hook versions',
                content: Buffer.from(updatedConfig).toString('base64'),
                sha: currentFile.sha,
                branch: branchName
              });

              console.log('✅ Updated .pre-commit-config.yaml');

              // Read update output
              const updateOutput = fs.readFileSync('update-output.txt', 'utf8');

              // Create PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'chore: update pre-commit hook versions',
                head: branchName,
                base: 'main',
                body: `## Update Pre-commit Hooks

            This PR updates the pre-commit hook versions to their latest releases.

            ### Changes

            \`\`\`
            ${updateOutput}
            \`\`\`

            ### Testing

            The pre-commit hooks will be automatically tested when this PR is created. To test locally:

            \`\`\`bash
            pre-commit run --all-files
            \`\`\`

            ---
            *This PR was automatically created by the pre-commit-updates workflow.*`
              });

              console.log(`✅ Created PR #${pr.number}`);

              // Add labels
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['dependencies', 'automated', 'release:patch']
              });

              console.log('✅ Added labels to PR');

            } catch (error) {
              console.error('Error creating PR:', error);
              
              // Create an issue instead if PR creation fails
              const updateOutput = fs.readFileSync('update-output.txt', 'utf8');
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⬆️ Pre-commit hook updates available',
                body: `## Pre-commit Hook Updates Available

            Updates are available for pre-commit hooks, but automatic PR creation failed.

            ### Updates Available

            \`\`\`
            ${updateOutput}
            \`\`\`

            ### Manual Update Instructions

            1. Update hooks locally:
               \`\`\`bash
               pre-commit autoupdate
               \`\`\`

            2. Test the updates:
               \`\`\`bash
               pre-commit run --all-files
               \`\`\`

            3. Commit and push:
               \`\`\`bash
               git checkout -b chore/update-pre-commit-hooks
               git add .pre-commit-config.yaml
               git commit -m "chore: update pre-commit hook versions"
               git push origin chore/update-pre-commit-hooks
               \`\`\`

            4. Create a PR and add the \`release:patch\` label.

            ---
            *This issue was automatically created by the pre-commit-updates workflow.*
            *Error: ${error.message}*`,
                labels: ['dependencies', 'automated', 'enhancement']
              });
            }
