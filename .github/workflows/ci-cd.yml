name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.pre-commit-config.yaml'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/dependabot.yml'
  pull_request:
    types: [opened, reopened, synchronize, labeled]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: read
  issues: write

jobs:
  check-trigger:
    name: Check CI/CD Trigger
    runs-on: ubuntu-slim
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "‚úÖ Running CI/CD (push to main)"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'ci/ready') }}" == "true" ]]; then
              echo "‚úÖ Running CI/CD (ci/ready label)"
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "‚è≠Ô∏è  Skipping CI/CD (add ci/ready label)"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "‚úÖ Running CI/CD (manual trigger)"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "should_run=false" >> $GITHUB_OUTPUT

  lint-dockerfile:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3018

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-slim
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Shellcheck
        run: |
          find . -name "*.sh" -o -name "*.bash" | while read file; do
            echo "Checking $file"
            dir=$(dirname "$file")
            (cd "$dir" && shellcheck --external-sources "$(basename "$file")") || exit 1
          done

  build-container:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: [lint-dockerfile, lint-shell]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build container for testing
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: ${{ github.event.repository.name }}:test
          platforms: linux/amd64
          cache-from: type=gha,scope=${{ github.ref }}
          cache-to: type=gha,mode=max,scope=${{ github.ref }}
      
      - name: Test container
        run: |
          echo "üß™ Running container tests"
          # Repository-specific tests here
          echo "‚úÖ Container tests passed"
      
      - name: Save container image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker save ${{ github.event.repository.name }}:test | gzip > container-image.tar.gz
      
      - name: Upload container artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v6
        with:
          name: container-image
          path: container-image.tar.gz
          retention-days: 1

  build-tarball:
    name: Build Source Tarball
    runs-on: ubuntu-slim
    needs: build-container
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Create tarball
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TARBALL="${REPO_NAME}-${SHORT_SHA}.tar.gz"
          
          tar -czf "$TARBALL" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.tar.gz' \
            --exclude='.pre-commit-config.yaml' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            .
          
          echo "‚úÖ Created $TARBALL"
      
      - name: Upload tarball
        uses: actions/upload-artifact@v6
        with:
          name: source-tarball
          path: "*.tar.gz"
          retention-days: 90

  check-release:
    name: Check Release Labels
    runs-on: ubuntu-slim
    needs: [build-container, build-tarball]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version_bump: ${{ steps.check.outputs.version_bump }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Check for release labels
        id: check
        uses: actions/github-script@v8
        with:
          script: |
            const commit = context.sha;
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commit
            });
            
            if (prs.data.length === 0) {
              console.log('‚ÑπÔ∏è  No PR associated with this commit');
              core.setOutput('should_release', 'false');
              return;
            }
            
            const pr = prs.data[0];
            const labels = pr.labels.map(l => l.name);
            console.log('üìã PR labels:', labels);
            
            if (labels.includes('release:major')) {
              core.setOutput('should_release', 'true');
              core.setOutput('version_bump', 'major');
            } else if (labels.includes('release:minor')) {
              core.setOutput('should_release', 'true');
              core.setOutput('version_bump', 'minor');
            } else if (labels.includes('release:patch')) {
              core.setOutput('should_release', 'true');
              core.setOutput('version_bump', 'patch');
            } else {
              console.log('‚ÑπÔ∏è  No release label found');
              core.setOutput('should_release', 'false');
            }

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Calculate version
        id: version
        run: |
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          CURRENT_VERSION=${CURRENT_VERSION#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          BUMP_TYPE="${{ needs.check-release.outputs.version_bump }}"
          if [ "$BUMP_TYPE" == "major" ]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [ "$BUMP_TYPE" == "minor" ]; then
            MINOR=$((MINOR + 1)); PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è  Version: $NEW_VERSION"
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download container artifact
        uses: actions/download-artifact@v6
        with:
          name: container-image
      
      - name: Load container image
        run: |
          docker load < container-image.tar.gz
          docker tag ${{ github.event.repository.name }}:test ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ steps.version.outputs.new_version }}
          docker tag ${{ github.event.repository.name }}:test ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
      
      - name: Push container images
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ steps.version.outputs.new_version }}
          docker push ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
      
      - name: Download tarball
        uses: actions/download-artifact@v6
        with:
          name: source-tarball
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            *.tar.gz
          body: |
            ## Container Image
            
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ steps.version.outputs.new_version }}
            ```
            
            Platform: linux/amd64
