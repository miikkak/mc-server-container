name: ShellCheck

on:
  push:
    branches: [main]
    paths: ['**.sh', '**.bash']
  pull_request:
    branches: [main]
    paths: ['**.sh', '**.bash']
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup ShellCheck
        run: |
          echo "üîç Checking environment"
          if ! command -v shellcheck > /dev/null; then
            sudo DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes apt-get update > /dev/null
            sudo DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes apt-get install \
              --no-install-recommends -y shellcheck > /dev/null
          fi

      - name: Run ShellCheck
        shell: bash
        run: |
          echo "üß™ Running ShellCheck on all shell scripts"
          output_file="$PWD/shellcheck.log"
          echo "" > "$output_file"
          exit_code=0

          while read -r file; do
            echo "üîç Checking $file" | tee -a "$output_file"
            dir=$(dirname "$file")
            pushd "$dir" > /dev/null || { echo "Failed to enter directory $dir"; exit 1; }
            shellcheck --external-sources "$(basename "$file")" 2>&1 | tee -a "$output_file"
            sc_exit=${PIPESTATUS[0]}
            popd > /dev/null || { echo "Failed to return from directory $dir"; exit 1; }
            if [ "$sc_exit" -ne 0 ]; then
              echo "‚ùå ShellCheck failed for $file" | tee -a "$output_file"
              exit_code=1
            fi
          done < <(find . -type f \( -name "*.sh" -o -name "*.bash" \))

          if [ "$exit_code" -eq 0 ]; then
            echo "‚úÖ All files passed ShellCheck"
            exit 0
          else
            echo "‚ùå Some ShellCheck errors found"
            exit 1
          fi

      - name: Upload ShellCheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shellcheck-results
          path: shellcheck.log

      - name: Create issue on failure
        if: failure() && github.event_name != 'pull_request'
        uses: peter-evans/create-issue-from-file@v6
        with:
          title: "ShellCheck failed on ${{ github.ref_name }}"
          content-filepath: ${{ github.workspace }}/shellcheck.log
          labels: |
            lint
            shellcheck

      - name: Label PR on failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['shellcheck-failed']
            })
