name: ShellCheck

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest-beta-small

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          set +e
          echo "üß™ Running ShellCheck on all .sh files"
          output_file="shellcheck.log"
          echo "" > "$output_file"
          exit_code=0

          find . -type f -name "*.sh" | while read -r file; do
            echo "üîç Checking $file" | tee -a "$output_file"
            dir=$(dirname "$file")
            pushd "$dir" > /dev/null
            shellcheck --external-sources "$(basename "$file")" 2>&1 | tee -a "../$output_file"
            sc_exit=${PIPESTATUS[0]}
            popd > /dev/null
            if [ $sc_exit -ne 0 ]; then
              echo "‚ùå ShellCheck failed for $file" | tee -a "$output_file"
              exit_code=1
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ All files passed ShellCheck"
            exit 0
          else
            echo "‚ùå Some ShellCheck errors found"
            exit 1
          fi

      - name: Label PR with shellcheck
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['shellcheck']
            })
