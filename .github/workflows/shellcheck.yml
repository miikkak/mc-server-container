name: ShellCheck

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-slim
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install ShellCheck
        run: |
          if ! command -v shellcheck > /dev/null; then
            sudo apt-get update > /dev/null
            sudo apt-get install --no-install-recommends -y shellcheck > /dev/null
          fi
          
      - name: Run ShellCheck
        run: |
          set +e
          echo "üß™ Running ShellCheck on all .sh files"
          output_file="$PWD/shellcheck.log"
          echo "" > "$output_file"
          exit_code=0

          while read -r file; do
            echo "üîç Checking $file" | tee -a "$output_file"
            dir=$(dirname "$file")
            pushd "$dir" > /dev/null
            shellcheck --external-sources "$(basename "$file")" 2>&1 | tee -a "$output_file"
            sc_exit=${PIPESTATUS[0]}
            popd > /dev/null
            if [ $sc_exit -ne 0 ]; then
              echo "‚ùå ShellCheck failed for $file" | tee -a "$output_file"
              exit_code=1
            fi
          done < <(find . -type f -name "*.sh")

          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ All files passed ShellCheck"
            exit 0
          else
            echo "‚ùå Some ShellCheck errors found"
            exit 1
          fi

      - name: Label PR with shellcheck
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['shellcheck']
            })
