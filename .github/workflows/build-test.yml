name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  hadolint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dockerfile not found, skipping hadolint"
          fi

      - name: Run hadolint
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3018
          # DL3008: Pin versions in apt-get install
          # DL3018: Pin versions in apk add

  build:
    name: Build Container
    runs-on: ubuntu-latest
    needs: hadolint
    if: success() || failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dockerfile not found, skipping build"
          fi

      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build container
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: mc-server-container:test
          cache-from: |
            type=gha,scope=${{ github.ref }}
            type=gha,scope=refs/heads/main
          cache-to: type=gha,mode=max,scope=${{ github.ref }}

  test:
    name: Test Container with Docker
    runs-on: ubuntu-latest
    needs: build
    if: success() || failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dockerfile not found, skipping tests"
          fi

      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build container for testing
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: mc-server-container:test
          cache-from: |
            type=gha,scope=${{ github.ref }}
            type=gha,scope=refs/heads/main
          cache-to: type=gha,mode=max,scope=${{ github.ref }}

      - name: Prepare test data
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üì¶ Preparing test data directory"
          mkdir -p test-data

          # Accept EULA
          echo "eula=true" > test-data/eula.txt
          echo "‚úÖ Created eula.txt"

          # Download Paper JAR
          echo "‚¨áÔ∏è  Downloading Paper JAR..."
          USER_AGENT="GitHub Actions for container build (miikka@iki.fi)"
          PAPER_VERSION=$(curl -s -H "User-Agent: $USER_AGENT" "https://fill.papermc.io/v3/projects/paper" | \
            jq -r '.versions | to_entries[0] | .value[0]')

          # Get latest build number
          BUILD_NUMBER=$(curl -s -H "User-Agent: $USER_AGENT" "https://fill.papermc.io/v3/projects/paper/versions/${PAPER_VERSION}" | \
            jq -r '.builds[0]')

          # Get download URL for $PAPER_VERSION-$BUILD_NUMBER
          DOWNLOAD_URL=$(curl -s -H "User-Agent: $USER_AGENT" "https://fill.papermc.io/v3/projects/paper/versions/${PAPER_VERSION}/builds" | \
            jq -r 'max_by(.id) | .downloads["server:default"].url')

          echo "üìã Downloading Paper ${PAPER_VERSION} build ${BUILD_NUMBER}"

          # Download Paper JAR
          curl -s -o test-data/paper.jar "${DOWNLOAD_URL}"

          # Verify download
          if [ ! -f test-data/paper.jar ]; then
            echo "‚ùå Failed to download Paper JAR"
            exit 1
          fi

          JAR_SIZE=$(stat -c%s test-data/paper.jar 2>/dev/null || stat -f%z test-data/paper.jar)
          echo "‚úÖ Downloaded Paper JAR (${JAR_SIZE} bytes)"

          # Change ownership to minecraft user (UID 25565)
          # This allows the container's minecraft user to write to /data
          echo "üîß Setting permissions for minecraft user"
          sudo chown -R 25565:25565 test-data
          echo "‚úÖ Permissions set"

      - name: Run integration tests
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üß™ Starting integration test with real Paper server"

          # Start container with actual data
          docker run -d --name mc-test \
            -v $(pwd)/test-data:/data \
            -e MEMORY=2G \
            mc-server-container:test

          echo "‚è≥ Waiting for Paper server to start (this may take 30-60 seconds)..."

          # Wait up to 90 seconds for server to start
          MAX_WAIT=90
          ELAPSED=0
          SERVER_STARTED=false

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if docker logs mc-test 2>&1 | grep -q "Done (.*s)! For help, type \"help\""; then
              SERVER_STARTED=true
              echo "‚úÖ Server started successfully after ${ELAPSED}s"
              break
            fi

            # Check if container is still running
            if [ "$(docker inspect -f '{{.State.Running}}' mc-test)" != "true" ]; then
              echo "‚ùå Container stopped unexpectedly"
              echo "üìã Container logs:"
              docker logs mc-test
              exit 1
            fi

            sleep 5
            ELAPSED=$((ELAPSED + 5))
            echo "  ... waiting (${ELAPSED}s / ${MAX_WAIT}s)"
          done

          if [ "$SERVER_STARTED" != "true" ]; then
            echo "‚ùå Server failed to start within ${MAX_WAIT} seconds"
            echo "üìã Container logs:"
            docker logs mc-test
            exit 1
          fi

          echo ""
          echo "üìã Server startup logs:"
          docker logs mc-test | tail -20

          echo ""
          echo "‚úÖ Integration test passed - Paper server started successfully"

          # Cleanup
          echo ""
          echo "üßπ Cleaning up test container"
          docker stop mc-test
          docker rm mc-test
          sudo rm -rf test-data

  test-podman:
    name: Test Container with Podman (OCI Compliance)
    runs-on: ubuntu-latest
    needs: build
    if: success() || failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dockerfile not found, skipping Podman tests"
          fi

      - name: Install Podman
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üì¶ Installing Podman"
          sudo apt-get update
          sudo apt-get install -y podman
          podman --version

      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build container for Podman testing
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          outputs: type=docker,dest=/tmp/mc-server-container.tar
          tags: mc-server-container:test
          cache-from: |
            type=gha,scope=${{ github.ref }}
            type=gha,scope=refs/heads/main

      - name: Load image into Podman
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üì• Loading Docker image into Podman (rootful storage)"
          # Load with sudo to place image in rootful storage, since we run with sudo later
          sudo podman load -i /tmp/mc-server-container.tar
          sudo podman images

      - name: Prepare test data for Podman
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üì¶ Preparing test data directory for Podman"
          mkdir -p test-data-podman

          # Accept EULA
          echo "eula=true" > test-data-podman/eula.txt
          echo "‚úÖ Created eula.txt"

          # Download Paper JAR
          echo "‚¨áÔ∏è  Downloading Paper JAR..."
          USER_AGENT="GitHub Actions for container build (miikka@iki.fi)"
          PAPER_VERSION=$(curl -s -H "User-Agent: $USER_AGENT" "https://fill.papermc.io/v3/projects/paper" | \
            jq -r '.versions | to_entries[0] | .value[0]')

          # Get latest build number
          BUILD_NUMBER=$(curl -s -H "User-Agent: $USER_AGENT" "https://fill.papermc.io/v3/projects/paper/versions/${PAPER_VERSION}" | \
            jq -r '.builds[0]')

          # Get download URL for $PAPER_VERSION-$BUILD_NUMBER
          DOWNLOAD_URL=$(curl -s -H "User-Agent: $USER_AGENT" "https://fill.papermc.io/v3/projects/paper/versions/${PAPER_VERSION}/builds" | \
            jq -r 'max_by(.id) | .downloads["server:default"].url')

          echo "üìã Downloading Paper ${PAPER_VERSION} build ${BUILD_NUMBER}"

          # Download Paper JAR
          curl -s -o test-data-podman/paper.jar "${DOWNLOAD_URL}"

          # Verify download
          if [ ! -f test-data-podman/paper.jar ]; then
            echo "‚ùå Failed to download Paper JAR"
            exit 1
          fi

          JAR_SIZE=$(stat -c%s test-data-podman/paper.jar 2>/dev/null || stat -f%z test-data-podman/paper.jar)
          echo "‚úÖ Downloaded Paper JAR (${JAR_SIZE} bytes)"

          # Change ownership to minecraft user (UID 25565)
          # This allows the container's minecraft user to write to /data
          echo "üîß Setting permissions for minecraft user"
          sudo chown -R 25565:25565 test-data-podman
          echo "‚úÖ Permissions set"

      - name: Run Podman integration tests
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "üß™ Starting Podman integration test (OCI compliance verification)"

          # Start container with Podman in rootful mode (using sudo)
          # Rootful mode ensures consistent UID mapping with Docker (container UID 25565 = host UID 25565)
          # Note: After podman load, the image is tagged as mc-server-container:test (without localhost prefix)
          sudo podman run -d --name mc-test-podman \
            -v $(pwd)/test-data-podman:/data:Z \
            -e EULA=TRUE \
            -e MEMORY=2G \
            mc-server-container:test

          echo "‚è≥ Waiting for Paper server to start with Podman (this may take 30-60 seconds)..."

          # Wait up to 90 seconds for server to start
          MAX_WAIT=90
          ELAPSED=0
          SERVER_STARTED=false

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if sudo podman logs mc-test-podman 2>&1 | grep -q "Done (.*s)! For help, type \"help\""; then
              SERVER_STARTED=true
              echo "‚úÖ Server started successfully with Podman after ${ELAPSED}s"
              break
            fi

            # Check if container is still running
            if [ "$(sudo podman inspect -f '{{.State.Running}}' mc-test-podman)" != "true" ]; then
              echo "‚ùå Container stopped unexpectedly"
              echo "üìã Container logs:"
              sudo podman logs mc-test-podman
              exit 1
            fi

            sleep 5
            ELAPSED=$((ELAPSED + 5))
            echo "  ... waiting (${ELAPSED}s / ${MAX_WAIT}s)"
          done

          if [ "$SERVER_STARTED" != "true" ]; then
            echo "‚ùå Server failed to start within ${MAX_WAIT} seconds"
            echo "üìã Container logs:"
            sudo podman logs mc-test-podman
            exit 1
          fi

          echo ""
          echo "üìã Server startup logs:"
          sudo podman logs mc-test-podman | tail -20

          echo ""
          echo "‚úÖ Podman integration test passed - OCI compliance verified!"

          # Cleanup
          echo ""
          echo "üßπ Cleaning up Podman test container"
          sudo podman stop mc-test-podman
          sudo podman rm mc-test-podman
          sudo rm -rf test-data-podman
