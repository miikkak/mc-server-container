name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  hadolint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dockerfile not found, skipping hadolint"
          fi

      - name: Run hadolint
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3018
          # DL3008: Pin versions in apt-get install
          # DL3018: Pin versions in apk add

  build:
    name: Build Container
    runs-on: ubuntu-latest
    needs: hadolint
    if: success() || failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dockerfile not found, skipping build"
          fi

      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build container
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: mc-server-container:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test:
    name: Test Container
    runs-on: ubuntu-latest
    needs: build
    if: success() || failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dockerfile not found, skipping tests"
          fi

      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build container for testing
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: mc-server-container:test
          cache-from: type=gha

      - name: Prepare test data
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "ğŸ“¦ Preparing test data directory"
          mkdir -p test-data

          # Accept EULA
          echo "eula=true" > test-data/eula.txt
          echo "âœ… Created eula.txt"

          # Download Paper JAR
          echo "â¬‡ï¸  Downloading Paper JAR..."
          PAPER_VERSION="1.21.3"

          # Get latest build number
          BUILD_NUMBER=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${PAPER_VERSION}" | \
            jq -r '.builds[-1]')

          echo "ğŸ“‹ Downloading Paper ${PAPER_VERSION} build ${BUILD_NUMBER}"

          # Download Paper JAR
          curl -s -o test-data/paper.jar \
            "https://api.papermc.io/v2/projects/paper/versions/${PAPER_VERSION}/builds/${BUILD_NUMBER}/downloads/paper-${PAPER_VERSION}-${BUILD_NUMBER}.jar"

          # Verify download
          if [ ! -f test-data/paper.jar ]; then
            echo "âŒ Failed to download Paper JAR"
            exit 1
          fi

          JAR_SIZE=$(stat -c%s test-data/paper.jar 2>/dev/null || stat -f%z test-data/paper.jar)
          echo "âœ… Downloaded Paper JAR (${JAR_SIZE} bytes)"

      - name: Run integration tests
        if: steps.check_dockerfile.outputs.exists == 'true'
        run: |
          echo "ğŸ§ª Starting integration test with real Paper server"

          # Start container with actual data
          docker run -d --name mc-test \
            -v $(pwd)/test-data:/data \
            -e MEMORY=2G \
            mc-server-container:test

          echo "â³ Waiting for Paper server to start (this may take 30-60 seconds)..."

          # Wait up to 90 seconds for server to start
          MAX_WAIT=90
          ELAPSED=0
          SERVER_STARTED=false

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if docker logs mc-test 2>&1 | grep -q "Done (.*s)! For help, type \"help\""; then
              SERVER_STARTED=true
              echo "âœ… Server started successfully after ${ELAPSED}s"
              break
            fi

            # Check if container is still running
            if [ "$(docker inspect -f '{{.State.Running}}' mc-test)" != "true" ]; then
              echo "âŒ Container stopped unexpectedly"
              echo "ğŸ“‹ Container logs:"
              docker logs mc-test
              exit 1
            fi

            sleep 5
            ELAPSED=$((ELAPSED + 5))
            echo "  ... waiting (${ELAPSED}s / ${MAX_WAIT}s)"
          done

          if [ "$SERVER_STARTED" != "true" ]; then
            echo "âŒ Server failed to start within ${MAX_WAIT} seconds"
            echo "ğŸ“‹ Container logs:"
            docker logs mc-test
            exit 1
          fi

          echo ""
          echo "ğŸ“‹ Server startup logs:"
          docker logs mc-test | tail -20

          echo ""
          echo "âœ… Integration test passed - Paper server started successfully"

          # Cleanup
          echo ""
          echo "ğŸ§¹ Cleaning up test container"
          docker stop mc-test
          docker rm mc-test
          rm -rf test-data
